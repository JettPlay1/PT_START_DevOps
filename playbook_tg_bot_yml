- name: Installing and setting up PostgreSQL master
  hosts: db
  become: yes

  tasks:
    - name: Installing PostgreSQL
      apt:
        name:
          - postgresql-14
          - postgresql-contrib-14
        state: present

    - name: Uploading .pgpass
      become_user: postgres
      copy:
        src: .pgpass
        dest: /var/lib/postgresql/.pgpass
        mode: 0600

    - name: Starting PostgreSQL
      service:
        name: postgresql
        state: started

    - name: Creating replication user
      become_user: postgres
      shell: psql -c "CREATE USER {{ hostvars['db']['DB_REPL_USER'] }} WITH REPLICATION ENCRYPTED PASSWORD '{{ hostvars['db']['DB_REPL_PASSWORD'] }}';"

    - name: Copying postgresql.conf
      template:
        src: postgresql.conf
        dest: /etc/postgresql/14/main/postgresql.conf
    
    - name: Copying pg_hba.conf
      template:
        src: pg_hba.conf
        dest: /etc/postgresql/14/main/pg_hba.conf
    
    - name: Restarting PostgreSQL
      service:
        name: postgresql
        state: restarted

- name:  Installing and setting up PostgreSQL slave
  hosts: db_repl
  become: yes

  tasks:
    - name: Installing PostgreSQL
      apt:
        name:
          - postgresql
          - postgresql-contrib
        state: present

    - name: Uploading .pgpass
      become_user: postgres
      copy:
        src: .pgpass
        dest: /var/lib/postgresql/.pgpass
        mode: 0600
    
    - name: Stopping PostgreSQL
      service:
        name: postgresql
        state: stopped
    
    - name: Adding address to postgresql.conf
      lineinfile:
        path: /etc/postgresql/14/main/postgresql.conf
        line: "listen_addresses='localhost, {{ hostvars['db']['ansible_host'] }}'"
        insertafter: EOF

    - name: Removing files from /var/lib/postresql/14/main/ folder
      become_user: postgres
      shell: rm -rf /var/lib/postgresql/14/main/*
    
    - name: Running pg_basebackup
      become_user: postgres
      shell: pg_basebackup -R -h {{ hostvars['db']['ansible_host'] }} -U repl_user -D /var/lib/postgresql/14/main
    
    - name: Starting PostgreSQL service
      service:
        name: postgresql
        state: started